<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Depósito Online - Plataforma</title>
  <style>
    body { background:#111; color:#eee; font-family:sans-serif; margin:0; padding:0; }
    .container { max-width:500px; margin:20px auto; background:#222; border-radius:12px; padding:20px; box-shadow:0 0 20px #00ff88aa; }
    .header { display:flex; justify-content:space-between; align-items:center; color:#00ff88; }
    .header h2 { margin:0; }
    .btn { background:linear-gradient(135deg,#00ff88,#0088ff); border:none; padding:10px 16px; border-radius:8px; color:#000; font-weight:bold; cursor:pointer; text-decoration:none; }
    .btn:hover { background:linear-gradient(135deg,#00cc66,#0055cc); color:#fff; }
    .form-group { margin:15px 0; }
    label { color:#00ff88; font-weight:bold; display:block; margin-bottom:6px; }
    input, select { width:100%; padding:10px; border:2px solid #00ff88; border-radius:8px; background:#111; color:#eee; }
    .amounts { display:flex; flex-wrap:wrap; gap:8px; margin:10px 0; }
    .amount-btn { flex:1 1 45%; text-align:center; padding:12px 0; background:#333; border:2px solid #555; border-radius:10px; cursor:pointer; color:#eee; font-weight:bold; user-select:none; }
    .amount-btn.selected { background:linear-gradient(135deg,#00ff88,#0088ff); color:#000; border-color:#00ff88; }
    .pix-box, .cronometro, .alerta { margin-top:15px; padding:10px; background:#111; border-radius:8px; }
    .pix-box strong { color:#00ff88; }
    .cronometro { color:#ff4444; font-size:18px; font-weight:bold; text-align:center; }
    .hidden { display:none !important; }
    #avisoPagamento {
      margin-top: 12px;
      color: #00ff88;
      font-weight: bold;
      font-size: 0.95rem;
    }
    /* Toast notification */
    #toast {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #00ff88;
      color: #000;
      padding: 12px 24px;
      border-radius: 30px;
      font-weight: bold;
      z-index: 9999;
      box-shadow: 0 0 12px #00ff88aa;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s ease, top 0.4s ease;
    }
    #toast.show {
      opacity: 1;
      pointer-events: auto;
      top: 20px;
    }
  </style>
</head>
<body>
<div class="container" role="main" aria-label="Formulário de depósito online">
  <div class="header">
    <h2>Depósito</h2>
    <div>
      <a class="btn" href="extrato-deposito.html" target="_blank" rel="noopener noreferrer" aria-label="Abrir extrato de depósitos">Extrato</a>
      <a class="btn" href="https://wa.me/5575998282201?text=Quero%20contratar%20uma%20plataforma%20da%20investe" target="_blank" rel="noopener noreferrer" aria-label="Contato de suporte via WhatsApp">Suporte</a>
    </div>
  </div>
  
  <form id="depositForm" novalidate>
    <div class="form-group">
      <label for="nomeTitular">Nome Completo</label>
      <input type="text" id="nomeTitular" name="nomeTitular" required aria-required="true" autocomplete="name" />
    </div>
    <div class="form-group">
      <label for="telefoneTitular">Telefone</label>
      <input type="tel" id="telefoneTitular" name="telefoneTitular" required aria-required="true" autocomplete="tel" placeholder="(00) 00000-0000"/>
    </div>
    <div class="form-group">
      <label for="cpfTitular">CPF</label>
      <input type="text" id="cpfTitular" name="cpfTitular" required aria-required="true" maxlength="14" placeholder="000.000.000-00" />
    </div>

    <div class="form-group">
      <label for="pix">Método de Depósito</label>
      <select id="pix" name="pix" aria-label="Método de depósito">
        <option value="pix">PIX</option>
        <option value="bank">Transferência Bancária</option>
      </select>
    </div>

    <div class="form-group">
      <label>Escolha o valor</label>
      <div class="amounts" id="amountBtns" role="radiogroup" aria-label="Valores para depósito"></div>
      <div id="avisoPagamento" class="hidden" aria-live="polite" aria-atomic="true">
        ⚠️ Copie a chave PIX acima, vá até o banco e faça o pagamento. Depois volte aqui para confirmar o depósito.
      </div>
    </div>

    <div class="pix-box hidden" id="pixBox" aria-live="polite" aria-atomic="true">
      Chave Pix: <strong id="pixKey"></strong>
      <button type="button" id="copyPixBtn" class="btn" aria-label="Copiar chave Pix para área de transferência" style="margin-top:10px;">Copiar chave Pix</button>
    </div>
    <div class="cronometro hidden" id="timer" aria-live="polite" aria-atomic="true" role="timer">05:00</div>

    <div class="form-group" id="actionButtons" style="margin-top:20px;">
      <button type="button" class="btn hidden" id="confirmar" aria-label="Confirmar depósito">Confirmar Depósito</button>
      <button type="button" class="btn hidden" id="cancelar" aria-label="Cancelar depósito" style="background: linear-gradient(135deg, #ff4444, #aa0000); margin-left:10px;">Cancelar</button>
    </div>

    <div class="alerta hidden" id="alerta" role="alert" aria-live="assertive" style="margin-top:15px;"></div>
  </form>
</div>

<div id="toast"></div>

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
<script>
  // Firebase config e init
  const firebaseConfig = {
    apiKey: "AIzaSyCKSKnVC8dNWmiMrNr1j4rMLfQTlOrqzVM",
    authDomain: "hinvest-f4354.firebaseapp.com",
    databaseURL: "https://hinvest-f4354-default-rtdb.firebaseio.com",
    projectId: "hinvest-f4354",
    storageBucket: "hinvest-f4354.appspot.com",
    messagingSenderId: "646397677016",
    appId: "1:646397677016:web:f05ca27a38439568bff6ad"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Valores e chaves PIX
  const valores = [60,160,300,450,500,650,700,850,900,1050];
  const pixKeys = {
    "60": "00020126870014br.gov.bcb.pix2565pix.primepag.com.br/qr/v3/at/da4ff1ca-6b69-463c-858a-98742a1f77625204000053039865802BR5925TRANSACAO_VERIFICADA_LTDA6012PORTO_ALEGRE62070503***63049138",
    "160": "00020126870014br.gov.bcb.pix2565pix.primepag.com.br/qr/v3/at/fc60a8a3-a994-4cdb-a81f-ba0972668cfa5204000053039865802BR5925TRANSACAO_VERIFICADA_LTDA6012PORTO_ALEGRE62070503***63047178",
    "300": "00020126870014br.gov.bcb.pix2565pix.primepag.com.br/qr/v3/at/06b63310-260f-4b9a-9a5c-172409082b265204000053039865802BR5925TRANSACAO_VERIFICADA_LTDA6012PORTO_ALEGRE62070503***6304A276",
    "450": "00020126870014br.gov.bcb.pix2565pix.primepag.com.br/qr/v3/at/63dc8390-7e11-4e0c-bcaa-41b7f7335b135204000053039865802BR5925TRANSACAO_VERIFICADA_LTDA6012PORTO_ALEGRE62070503***6304EE94",
    "500": "00020126870014br.gov.bcb.pix2565pix.primepag.com.br/qr/v3/at/e351ddd9-c620-43aa-b943-fb046ec190285204000053039865802BR5925TRANSACAO_VERIFICADA_LTDA6012PORTO_ALEGRE62070503***630454F1",
    "650": "pix650@hfinvest.com",
    "700": "pix700@hfinvest.com",
    "850": "pix850@hfinvest.com",
    "900": "pix900@hfinvest.com",
    "1050": "pix1050@hfinvest.com"
  };

  const telefoneLogado = localStorage.getItem("telefoneLogado") || "desconhecido";

  const amountDiv = document.getElementById("amountBtns");
  const pixBox = document.getElementById("pixBox");
  const pixKeyEl = document.getElementById("pixKey");
  const timerEl = document.getElementById("timer");
  const confirmarBtn = document.getElementById("confirmar");
  const cancelarBtn = document.getElementById("cancelar");
  const alerta = document.getElementById("alerta");
  const copyPixBtn = document.getElementById("copyPixBtn");
  const avisoPagamento = document.getElementById("avisoPagamento");
  const depositForm = document.getElementById("depositForm");

  const nomeInput = document.getElementById("nomeTitular");
  const telefoneInput = document.getElementById("telefoneTitular");
  const cpfInput = document.getElementById("cpfTitular");
  const metodoInput = document.getElementById("pix");

  let valorSelecionado = null;
  let timerInterval = null;
  let tempoRestante = 300;

  function criarBotoesValores() {
    valores.forEach((v, i) => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "amount-btn";
      btn.textContent = `R$ ${v}`;
      btn.setAttribute("role", "radio");
      btn.setAttribute("aria-checked", "false");
      btn.tabIndex = i === 0 ? 0 : -1;
      btn.addEventListener("click", () => selecionarValor(btn, v));
      amountDiv.appendChild(btn);
    });
  }

  // Função para validar CPF com cálculo oficial
  function validarCPF(cpf) {
    cpf = cpf.replace(/[^\d]+/g, "");
    if(cpf.length !== 11 || /^(\d)\1+$/.test(cpf)) return false;
    let soma = 0;
    for(let i=0; i<9; i++) soma += parseInt(cpf.charAt(i)) * (10 - i);
    let resto = (soma * 10) % 11;
    if(resto === 10 || resto === 11) resto = 0;
    if(resto !== parseInt(cpf.charAt(9))) return false;
    soma = 0;
    for(let i=0; i<10; i++) soma += parseInt(cpf.charAt(i)) * (11 - i);
    resto = (soma * 10) % 11;
    if(resto === 10 || resto === 11) resto = 0;
    if(resto !== parseInt(cpf.charAt(10))) return false;
    return true;
  }

  function validarFormulario() {
    const nomeVal = nomeInput.value.trim();
    const telefoneVal = telefoneInput.value.trim();
    const cpfVal = cpfInput.value.trim();

    if(nomeVal.length < 3) {
      alerta.textContent = "Por favor, preencha o nome completo.";
      alerta.classList.remove("hidden");
      return false;
    }

    // Telefone regex (com máscara)
    const telRegex = /^\(\d{2}\)\s?\d{4,5}-\d{4}$/;
    if(!telRegex.test(telefoneVal)) {
      alerta.textContent = "Telefone inválido. Use o formato (00) 00000-0000.";
      alerta.classList.remove("hidden");
      return false;
    }

    // CPF regex formatado
    const cpfRegex = /^\d{3}\.\d{3}\.\d{3}-\d{2}$/;
    if(!cpfRegex.test(cpfVal)) {
      alerta.textContent = "CPF inválido. Use o formato 000.000.000-00.";
      alerta.classList.remove("hidden");
      return false;
    }

    // Valida o CPF com cálculo
    if(!validarCPF(cpfVal)) {
      alerta.textContent = "CPF inválido.";
      alerta.classList.remove("hidden");
      return false;
    }

    alerta.classList.add("hidden");
    return true;
  }

  function selecionarValor(btn, valor) {
    if(!validarFormulario()) {
      avisoPagamento.classList.add("hidden");
      return;
    }
    alerta.classList.add("hidden");

    amountDiv.querySelectorAll("button").forEach(b => {
      b.classList.remove("selected");
      b.setAttribute("aria-checked", "false");
      b.tabIndex = -1;
    });
    btn.classList.add("selected");
    btn.setAttribute("aria-checked", "true");
    btn.tabIndex = 0;

    valorSelecionado = valor;

    pixKeyEl.textContent = pixKeys[valor];
    pixBox.classList.remove("hidden");
    confirmarBtn.classList.remove("hidden");
    cancelarBtn.classList.remove("hidden");
    timerEl.classList.remove("hidden");
    avisoPagamento.classList.remove("hidden");

    iniciarCronometro();
  }

  copyPixBtn.addEventListener("click", () => {
    navigator.clipboard.writeText(pixKeyEl.textContent).then(() => {
      showToast("Chave Pix copiada com sucesso!");
    }).catch(() => {
      alerta.textContent = "Erro ao copiar chave Pix.";
      alerta.classList.remove("hidden");
    });
  });

  function iniciarCronometro() {
    clearInterval(timerInterval);
    tempoRestante = 300;
    atualizarTimer();

    timerInterval = setInterval(() => {
      tempoRestante--;
      atualizarTimer();
      if(tempoRestante <= 0) {
        clearInterval(timerInterval);
        alerta.textContent = "Tempo esgotado. Gere o código novamente.";
        alerta.classList.remove("hidden");
        resetarFormulario();
      }
    }, 1000);
  }

  function atualizarTimer() {
    const min = Math.floor(tempoRestante / 60);
    const seg = tempoRestante % 60;
    timerEl.textContent = `${min.toString().padStart(2,"0")}:${seg.toString().padStart(2,"0")}`;
  }

  function registrarDeposito(status) {
    if(!valorSelecionado) {
      alerta.textContent = "Nenhum valor selecionado.";
      alerta.classList.remove("hidden");
      return;
    }
    if(!validarFormulario()) {
      return;
    }

    const dataAtual = new Date().toISOString();

    const deposito = {
      nome: nomeInput.value.trim(),
      telefone: telefoneInput.value.trim(),
      cpf: cpfInput.value.trim(),
      valor: valorSelecionado,
      chavePix: pixKeys[valorSelecionado],
      metodoPagamento: metodoInput.value,
      status: status,
      data: dataAtual,
      telefoneLogado: telefoneLogado
    };

    db.ref(`usuarios/${telefoneLogado}/extratosDepositos`).push(deposito)
    .then(() => {
      showToast(`Depósito ${status === 'pendente' ? 'confirmado' : 'cancelado'} com sucesso.`);
      resetarFormulario();
    })
    .catch(erro => {
      alerta.textContent = `Erro ao registrar depósito: ${erro.message}`;
      alerta.classList.remove("hidden");
    });
  }

  function resetarFormulario() {
    valorSelecionado = null;
    clearInterval(timerInterval);
    timerEl.classList.add("hidden");
    pixBox.classList.add("hidden");
    confirmarBtn.classList.add("hidden");
    cancelarBtn.classList.add("hidden");
    alerta.classList.add("hidden");
    avisoPagamento.classList.add("hidden");
    timerEl.textContent = "05:00";
    amountDiv.querySelectorAll("button").forEach(b => {
      b.classList.remove("selected");
      b.setAttribute("aria-checked", "false");
      b.tabIndex = -1;
    });
  }

  confirmarBtn.addEventListener("click", () => registrarDeposito("pendente"));
  cancelarBtn.addEventListener("click", () => registrarDeposito("cancelado"));

  // Máscara para telefone
  telefoneInput.addEventListener("input", e => {
    let v = e.target.value.replace(/\D/g,"");
    if(v.length > 11) v = v.slice(0,11);
    if(v.length > 10) {
      // (00) 00000-0000
      v = v.replace(/^(\d{2})(\d{5})(\d{4}).*/, "($1) $2-$3");
    } else if(v.length > 5) {
      // (00) 0000-0000
      v = v.replace(/^(\d{2})(\d{4})(\d{0,4}).*/, "($1) $2-$3");
    } else if(v.length > 2) {
      v = v.replace(/^(\d{2})(\d{0,5})/, "($1) $2");
    } else if(v.length > 0) {
      v = v.replace(/^(\d*)/, "($1");
    }
    e.target.value = v;
  });

  // Máscara para CPF
  cpfInput.addEventListener("input", e => {
    let v = e.target.value.replace(/\D/g,"");
    if(v.length > 11) v = v.slice(0,11);
    if(v.length > 9) {
      v = v.replace(/^(\d{3})(\d{3})(\d{3})(\d{0,2}).*/, "$1.$2.$3-$4");
    } else if(v.length > 6) {
      v = v.replace(/^(\d{3})(\d{3})(\d{0,3}).*/, "$1.$2.$3");
    } else if(v.length > 3) {
      v = v.replace(/^(\d{3})(\d{0,3}).*/, "$1.$2");
    }
    e.target.value = v;
  });

  // Função toast para notificações no topo
  const toastEl = document.getElementById("toast");
  let toastTimeout = null;

  function showToast(msg) {
    clearTimeout(toastTimeout);
    toastEl.textContent = msg;
    toastEl.classList.add("show");
    toastTimeout = setTimeout(() => {
      toastEl.classList.remove("show");
    }, 3000);
  }

  criarBotoesValores();
</script>
</body>
</html>

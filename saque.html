<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Carteira - HInvest</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #000;
      color: #fff;
      padding: 20px;
    }
    h2 {
      color: #0f0;
    }
    .info {
      margin-bottom: 10px;
    }
    label {
      display: block;
      margin-top: 10px;
    }
    input, select, button {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      font-size: 16px;
    }
    button {
      background: #28a745;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:disabled {
      background: #666;
    }
    .btn-extrato {
      background: #007bff;
      margin-top: 20px;
    }
    .aviso {
      background: #111;
      border: 1px solid #333;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 5px;
      color: #ff0;
    }
    .titulo-destaque {
      color: #00ffcc;
      font-size: 20px;
      margin-bottom: 10px;
    }
    .extrato-retirada {
      margin-top: 20px;
      padding: 10px;
      background: #333;
      border-radius: 5px;
    }
  </style>
</head>
<body>

<h2>Carteira - HInvest</h2>

<div class="aviso">
  <div class="titulo-destaque">‚è∞ Tempo de pagamento:</div>
  Pagamos de 1 minuto at√© 2 horas. Hor√°rio de pagamento √© de 8h √†s 22h. Hor√°rio de Bras√≠lia.
</div>

<div class="aviso">
  <div class="titulo-destaque">‚ö†Ô∏è Aviso importante:</div>
  A plataforma exige <strong>recarga m√≠nima de R$ 60</strong> para liberar os saques.
</div>

<div class="aviso">
  <div class="titulo-destaque">üíµ Sobre saques:</div>
  N√£o adianta pedir saque se ainda n√£o tiver feito uma recarga m√≠nima de R$ 60. Recargas de teste n√£o ser√£o consideradas.
</div>

<h2>Saldo da Carteira</h2>
<div class="info">Saldo: <span id="saldo-carteira">R$ 0,00</span></div>
<div class="info">Valor Recebido: <span id="valor-recebimento">R$ 0,00</span></div>
<div class="info">Valor Retirado: <span id="valor-retirada">R$ 0,00</span></div>

<h2>Extrato de Retirada</h2>
<div id="extrato-retirada" class="extrato-retirada">
  <!-- As retiradas realizadas ser√£o exibidas aqui -->
</div>

<button class="btn-extrato" id="verExtrato">Ver Extrato de Retirada</button>

<h2>Conta Banc√°ria</h2>
<label>Nome do Titular</label>
<input type="text" id="nomeTitular">
<label>Tipo de Chave</label>
<select id="tipoChave">
  <option value="CPF">CPF</option>
  <option value="Email">Email</option>
  <option value="Telefone">Telefone</option>
</select>
<label>Chave Pix</label>
<input type="text" id="chavePix">
<button id="salvarConta">Salvar Conta</button>

<h2>Sacar</h2>
<label>Valor do Saque</label>
<input type="number" id="valorSaque" placeholder="Digite o valor" oninput="calcularValorRecebido()">
<div class="info">Taxa (12%): <span id="valorTaxa">R$ 0,00</span></div>
<div class="info">Valor L√≠quido: <span id="valorLiquido">R$ 0,00</span></div>
<button id="confirmarSaque" disabled>Confirmar Saque</button>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCKSKnVC8dNWmiMrNr1j4rMLfQTlOrqzVM",
    authDomain: "hinvest-f4354.firebaseapp.com",
    databaseURL: "https://hinvest-f4354-default-rtdb.firebaseio.com",
    projectId: "hinvest-f4354",
    storageBucket: "hinvest-f4354.appspot.com",
    messagingSenderId: "646397677016",
    appId: "1:646397677016:web:f05ca27a38439568bff6ad"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const userId = localStorage.getItem('telefoneLogado');
  const userRef = db.ref("usuarios/" + userId);

  function atualizarTela(data) {
    const saldo = parseFloat(data.saldoCarteira || 0).toFixed(2);
    const receb = parseFloat(data.recebimento || 0).toFixed(2);
    const retirada = parseFloat(data.retirada || 0).toFixed(2);

    document.getElementById("saldo-carteira").textContent = "R$ " + saldo.replace(".", ",");
    document.getElementById("valor-recebimento").textContent = "R$ " + receb.replace(".", ",");
    document.getElementById("valor-retirada").textContent = "R$ " + retirada.replace(".", ",");

    const extratoDiv = document.getElementById("extrato-retirada");
    if (data.extrato && data.extrato.length > 0) {
      extratoDiv.innerHTML = "";
      data.extrato.forEach(saque => {
        extratoDiv.innerHTML += `<div><strong>Retirada:</strong> R$ ${saque.valor.toFixed(2).replace(".", ",")} <br><strong>Valor Recebido:</strong> R$ ${saque.valorLiquido.toFixed(2).replace(".", ",")} <br><strong>Data:</strong> ${saque.dataSolicitacao}</div><hr>`;
      });
    }

    const temPlanoAtivo = data.investimentos && data.investimentos.some(investimento => investimento.status === 'comprado');
    if (temPlanoAtivo) {
      document.getElementById("confirmarSaque").disabled = false;
    } else {
      document.getElementById("confirmarSaque").disabled = true;
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    if (!userId) {
      alert("Usu√°rio n√£o logado.");
      window.location.href = "index.html";
      return;
    }
    userRef.once("value").then(snapshot => {
      const data = snapshot.val() || {};
      atualizarTela(data);
    });
  });

  document.getElementById("salvarConta").addEventListener("click", () => {
    const nome = document.getElementById("nomeTitular").value.trim();
    const tipo = document.getElementById("tipoChave").value;
    const chave = document.getElementById("chavePix").value.trim();

    if (!nome || !chave) {
      alert("Preencha todos os campos da conta.");
      return;
    }

    userRef.update({
      contaBancaria: {
        nomeTitular: nome,
        tipoChave: tipo,
        chavePix: chave
      }
    });

    alert("Conta banc√°ria salva com sucesso!");
    document.getElementById("salvarConta").disabled = true;
  });

  function calcularValorRecebido() {
    const valor = parseFloat(document.getElementById("valorSaque").value);
    if (!isNaN(valor) && valor >= 20) {
      const taxa = valor * 0.12;
      const liquido = valor - taxa;
      document.getElementById("valorTaxa").textContent = "R$ " + taxa.toFixed(2).replace(".", ",");
      document.getElementById("valorLiquido").textContent = "R$ " + liquido.toFixed(2).replace(".", ",");
    } else {
      document.getElementById("valorTaxa").textContent = "R$ 0,00";
      document.getElementById("valorLiquido").textContent = "R$ 0,00";
    }
  }

  document.getElementById("confirmarSaque").addEventListener("click", () => {
    const valor = parseFloat(document.getElementById("valorSaque").value);
    if (valor < 20) {
      alert("O valor m√≠nimo de saque √© R$20.");
      return;
    }

    userRef.once("value").then(snapshot => {
      const data = snapshot.val();
      if (data.saldoCarteira < valor) {
        alert("Saldo insuficiente para o saque.");
        return;
      }

      const valorLiquido = valor - (valor * 0.12);
      const dataSaque = new Date().toLocaleString();

      userRef.update({
        saldoCarteira: data.saldoCarteira - valor,
        retirada: (data.retirada || 0) + valor,
        extrato: (data.extrato || []).concat([{ valor, valorLiquido, dataSolicitacao: dataSaque }])
      });

      alert("Saque solicitado com sucesso!");
      atualizarTela({ ...data, extrato: [...(data.extrato || []), { valor, valorLiquido, dataSolicitacao: dataSaque }] });
    });
  });

  // Fun√ß√£o do bot√£o de extrato
  document.getElementById("verExtrato").addEventListener("click", () => {
    window.location.href = "extrato.html";
  });
</script>

</body>
</html>
